{"version":3,"sources":["../src/CancelablePromise.ts"],"names":["CancelablePromiseInternal","executor","internals","defaultInternals","promise","Promise","resolve","reject","onCancel","onCancelList","push","cancel","bind","onfulfilled","onrejected","makeCancelable","then","createCallback","catch","onfinally","runWhenCanceled","finally","filter","callback","isCanceled","callbacks","err","console","error","CancelablePromise","all","iterable","makeAllCancelable","allSettled","race","value","cancelable","reason","isCancelablePromise","onResult","arg","result","resolvable"],"mappings":"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","sourcesContent":["class CancelablePromiseInternal<T = any> {\n  #internals: Internals;\n  #promise: Promise<T>;\n\n  constructor({\n    executor = () => {},\n    internals = defaultInternals(),\n    promise = new Promise<T>((resolve, reject) =>\n      executor(resolve, reject, (onCancel) => {\n        internals.onCancelList.push(onCancel);\n      })\n    ),\n  }: {\n    executor?: (\n      resolve: (value: T | PromiseLike<T>) => void,\n      reject: (reason?: any) => void,\n      onCancel: (cancelHandler: () => void) => void\n    ) => void;\n    internals?: Internals;\n    promise?: Promise<T>;\n  }) {\n    this.cancel = this.cancel.bind(this);\n    this.#internals = internals;\n    this.#promise =\n      promise ||\n      new Promise<T>((resolve, reject) =>\n        executor(resolve, reject, (onCancel) => {\n          internals.onCancelList.push(onCancel);\n        })\n      );\n  }\n\n  then<TResult1 = T, TResult2 = never>(\n    onfulfilled?:\n      | ((\n          value: T\n        ) => TResult1 | PromiseLike<TResult1> | CancelablePromise<TResult1>)\n      | undefined\n      | null,\n    onrejected?:\n      | ((\n          reason: any\n        ) => TResult2 | PromiseLike<TResult2> | CancelablePromise<TResult2>)\n      | undefined\n      | null\n  ): CancelablePromise<TResult1 | TResult2> {\n    return makeCancelable<TResult1 | TResult2>(\n      this.#promise.then(\n        createCallback(onfulfilled, this.#internals),\n        createCallback(onrejected, this.#internals)\n      ),\n      this.#internals\n    );\n  }\n\n  catch<TResult = never>(\n    onrejected?:\n      | ((\n          reason: any\n        ) => TResult | PromiseLike<TResult> | CancelablePromise<TResult>)\n      | undefined\n      | null\n  ): CancelablePromise<T | TResult> {\n    return makeCancelable<T | TResult>(\n      this.#promise.catch(createCallback(onrejected, this.#internals)),\n      this.#internals\n    );\n  }\n\n  finally(\n    onfinally?: (() => void) | undefined | null,\n    runWhenCanceled?: boolean\n  ): CancelablePromise<T> {\n    if (runWhenCanceled) {\n      this.#internals.onCancelList.push(onfinally);\n    }\n    return makeCancelable<T>(\n      this.#promise.finally(\n        createCallback(() => {\n          if (onfinally) {\n            if (runWhenCanceled) {\n              this.#internals.onCancelList =\n                this.#internals.onCancelList.filter(\n                  (callback) => callback !== onfinally\n                );\n            }\n            return onfinally();\n          }\n        }, this.#internals)\n      ),\n      this.#internals\n    );\n  }\n\n  cancel(): void {\n    this.#internals.isCanceled = true;\n    const callbacks = this.#internals.onCancelList;\n    this.#internals.onCancelList = [];\n    for (const callback of callbacks) {\n      if (typeof callback === 'function') {\n        try {\n          callback();\n        } catch (err) {\n          console.error(err);\n        }\n      }\n    }\n  }\n\n  isCanceled(): boolean {\n    return this.#internals.isCanceled === true;\n  }\n}\n\nexport class CancelablePromise<T = any> extends CancelablePromiseInternal<T> {\n  static all = function all(iterable: any) {\n    return makeAllCancelable(iterable, Promise.all(iterable));\n  } as CancelablePromiseOverloads['all'];\n\n  static allSettled = function allSettled(iterable: any) {\n    return makeAllCancelable(iterable, Promise.allSettled(iterable));\n  } as CancelablePromiseOverloads['allSettled'];\n\n  static race = function race(iterable) {\n    return makeAllCancelable(iterable, Promise.race(iterable));\n  } as CancelablePromiseOverloads['race'];\n\n  static resolve = function resolve(value) {\n    return cancelable(Promise.resolve(value));\n  } as CancelablePromiseOverloads['resolve'];\n\n  static reject = function reject(reason) {\n    return cancelable(Promise.reject(reason));\n  } as CancelablePromiseOverloads['reject'];\n\n  static isCancelable = isCancelablePromise;\n\n  constructor(\n    executor: (\n      resolve: (value: T | PromiseLike<T>) => void,\n      reject: (reason?: any) => void,\n      onCancel: (cancelHandler: () => void) => void\n    ) => void\n  ) {\n    super({ executor });\n  }\n}\n\nexport default CancelablePromise;\n\nexport function cancelable<T = any>(promise: Promise<T>): CancelablePromise<T> {\n  return makeCancelable(promise, defaultInternals());\n}\n\nexport function isCancelablePromise(promise: any): boolean {\n  return (\n    promise instanceof CancelablePromise ||\n    promise instanceof CancelablePromiseInternal\n  );\n}\n\nfunction createCallback(onResult: any, internals: Internals) {\n  if (onResult) {\n    return (arg?: any) => {\n      if (!internals.isCanceled) {\n        const result = onResult(arg);\n        if (isCancelablePromise(result)) {\n          internals.onCancelList.push(result.cancel);\n        }\n        return result;\n      }\n      return arg;\n    };\n  }\n}\n\nfunction makeCancelable<T>(promise: Promise<T>, internals: Internals) {\n  return new CancelablePromiseInternal<T>({\n    internals,\n    promise,\n  }) as CancelablePromise<T>;\n}\n\nfunction makeAllCancelable(iterable: any, promise: Promise<any>) {\n  const internals = defaultInternals();\n  internals.onCancelList.push(() => {\n    for (const resolvable of iterable) {\n      if (isCancelablePromise(resolvable)) {\n        resolvable.cancel();\n      }\n    }\n  });\n  return new CancelablePromiseInternal({ internals, promise });\n}\n\nfunction defaultInternals(): Internals {\n  return { isCanceled: false, onCancelList: [] };\n}\n\ninterface Internals {\n  isCanceled: boolean;\n  onCancelList: any[];\n}\n\ninterface CancelablePromiseOverloads {\n  all<T1, T2, T3, T4, T5, T6, T7, T8, T9, T10, T11, T12>(\n    values: readonly [\n      T1 | PromiseLike<T1>,\n      T2 | PromiseLike<T2>,\n      T3 | PromiseLike<T3>,\n      T4 | PromiseLike<T4>,\n      T5 | PromiseLike<T5>,\n      T6 | PromiseLike<T6>,\n      T7 | PromiseLike<T7>,\n      T8 | PromiseLike<T8>,\n      T9 | PromiseLike<T9>,\n      T10 | PromiseLike<T10>,\n      T11 | PromiseLike<T11>,\n      T12 | PromiseLike<T12>\n    ]\n  ): CancelablePromise<[T1, T2, T3, T4, T5, T6, T7, T8, T9, T10, T11, T12]>;\n\n  all<T1, T2, T3, T4, T5, T6, T7, T8, T9, T10, T11>(\n    values: readonly [\n      T1 | PromiseLike<T1>,\n      T2 | PromiseLike<T2>,\n      T3 | PromiseLike<T3>,\n      T4 | PromiseLike<T4>,\n      T5 | PromiseLike<T5>,\n      T6 | PromiseLike<T6>,\n      T7 | PromiseLike<T7>,\n      T8 | PromiseLike<T8>,\n      T9 | PromiseLike<T9>,\n      T10 | PromiseLike<T10>,\n      T11 | PromiseLike<T11>\n    ]\n  ): CancelablePromise<[T1, T2, T3, T4, T5, T6, T7, T8, T9, T10, T11]>;\n\n  all<T1, T2, T3, T4, T5, T6, T7, T8, T9, T10>(\n    values: readonly [\n      T1 | PromiseLike<T1>,\n      T2 | PromiseLike<T2>,\n      T3 | PromiseLike<T3>,\n      T4 | PromiseLike<T4>,\n      T5 | PromiseLike<T5>,\n      T6 | PromiseLike<T6>,\n      T7 | PromiseLike<T7>,\n      T8 | PromiseLike<T8>,\n      T9 | PromiseLike<T9>,\n      T10 | PromiseLike<T10>\n    ]\n  ): CancelablePromise<[T1, T2, T3, T4, T5, T6, T7, T8, T9, T10]>;\n\n  all<T1, T2, T3, T4, T5, T6, T7, T8, T9>(\n    values: readonly [\n      T1 | PromiseLike<T1>,\n      T2 | PromiseLike<T2>,\n      T3 | PromiseLike<T3>,\n      T4 | PromiseLike<T4>,\n      T5 | PromiseLike<T5>,\n      T6 | PromiseLike<T6>,\n      T7 | PromiseLike<T7>,\n      T8 | PromiseLike<T8>,\n      T9 | PromiseLike<T9>\n    ]\n  ): CancelablePromise<[T1, T2, T3, T4, T5, T6, T7, T8, T9]>;\n\n  all<T1, T2, T3, T4, T5, T6, T7, T8>(\n    values: readonly [\n      T1 | PromiseLike<T1>,\n      T2 | PromiseLike<T2>,\n      T3 | PromiseLike<T3>,\n      T4 | PromiseLike<T4>,\n      T5 | PromiseLike<T5>,\n      T6 | PromiseLike<T6>,\n      T7 | PromiseLike<T7>,\n      T8 | PromiseLike<T8>\n    ]\n  ): CancelablePromise<[T1, T2, T3, T4, T5, T6, T7, T8]>;\n\n  all<T1, T2, T3, T4, T5, T6, T7>(\n    values: readonly [\n      T1 | PromiseLike<T1>,\n      T2 | PromiseLike<T2>,\n      T3 | PromiseLike<T3>,\n      T4 | PromiseLike<T4>,\n      T5 | PromiseLike<T5>,\n      T6 | PromiseLike<T6>,\n      T7 | PromiseLike<T7>\n    ]\n  ): CancelablePromise<[T1, T2, T3, T4, T5, T6, T7]>;\n\n  all<T1, T2, T3, T4, T5, T6>(\n    values: readonly [\n      T1 | PromiseLike<T1>,\n      T2 | PromiseLike<T2>,\n      T3 | PromiseLike<T3>,\n      T4 | PromiseLike<T4>,\n      T5 | PromiseLike<T5>,\n      T6 | PromiseLike<T6>\n    ]\n  ): CancelablePromise<[T1, T2, T3, T4, T5, T6]>;\n\n  all<T1, T2, T3, T4, T5>(\n    values: readonly [\n      T1 | PromiseLike<T1>,\n      T2 | PromiseLike<T2>,\n      T3 | PromiseLike<T3>,\n      T4 | PromiseLike<T4>,\n      T5 | PromiseLike<T5>\n    ]\n  ): CancelablePromise<[T1, T2, T3, T4, T5]>;\n\n  all<T1, T2, T3, T4>(\n    values: readonly [\n      T1 | PromiseLike<T1>,\n      T2 | PromiseLike<T2>,\n      T3 | PromiseLike<T3>,\n      T4 | PromiseLike<T4>\n    ]\n  ): CancelablePromise<[T1, T2, T3, T4]>;\n\n  all<T1, T2, T3>(\n    values: readonly [\n      T1 | PromiseLike<T1>,\n      T2 | PromiseLike<T2>,\n      T3 | PromiseLike<T3>\n    ]\n  ): CancelablePromise<[T1, T2, T3]>;\n\n  all<T1, T2>(\n    values: readonly [T1 | PromiseLike<T1>, T2 | PromiseLike<T2>]\n  ): CancelablePromise<[T1, T2]>;\n\n  all<T>(values: readonly (T | PromiseLike<T>)[]): CancelablePromise<T[]>;\n\n  allSettled<T extends readonly unknown[] | readonly [unknown]>(\n    values: T\n  ): CancelablePromise<\n    {\n      -readonly [P in keyof T]: PromiseSettledResult<\n        T[P] extends PromiseLike<infer U> ? U : T[P]\n      >;\n    }\n  >;\n\n  allSettled<T>(\n    values: Iterable<T>\n  ): CancelablePromise<\n    PromiseSettledResult<T extends PromiseLike<infer U> ? U : T>[]\n  >;\n\n  race<T>(\n    values: readonly T[]\n  ): CancelablePromise<T extends PromiseLike<infer U> ? U : T>;\n\n  resolve(): CancelablePromise<void>;\n\n  resolve<T>(\n    value: T | PromiseLike<T> | CancelablePromise<T>\n  ): CancelablePromise<T>;\n\n  reject<T = never>(reason?: any): CancelablePromise<T>;\n}\n"],"file":"CancelablePromise.js"}